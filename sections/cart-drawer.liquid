<cart-drawer id="cart-drawer" class="cart-drawer drawer {% if cart.empty? %}drawer--center-body{% endif %} color-scheme color-scheme--{{ section.settings.color_scheme.id }}" initial-focus="false" handle-editor-events>
  <p class="h4" slot="header">{{ 'cart.general.title' | t }}</p>

  {%- if cart.empty? -%}
    <p class="h5 text-center">{{ 'cart.general.empty' | t }}</p>
  {%- else -%}
    {%- if settings.cart_show_free_shipping_bar -%}
      {%- render 'free-shipping-bar' -%}
    {%- endif -%}

    <div class="cart-drawer__items">
      {%- for line_item in cart.items -%}
        {%- render 'line-item', line_item: line_item, show_quantity_selector: true -%}
      {%- endfor -%}
    </div>

    {%- liquid
      assign cross_sell_products_count = 0

      for product in section.settings.cross_sell_products
        assign items_for_product = cart | line_items_for: product

        if items_for_product.size == 0 and product.available
          assign cross_sell_products_count = cross_sell_products_count | plus: 1
        endif
      endfor
    -%}

    {%- if cross_sell_products_count > 0 -%}
      <div class="cart-drawer__complementary-products complementary-products">
        {%- assign carousel_id = 'complementary-products-carousel-' | append: section.id -%}

        {%- if section.settings.cross_sell_title != blank or section.settings.cross_sell_stack_products == false and cross_sell_products_count > 1 -%}
          <div class="complementary-products__header complementary-products__header--align-start">
            <p class="h6">{{ section.settings.cross_sell_title }}</p>

            {%- if section.settings.cross_sell_stack_products == false and cross_sell_products_count > 1 -%}
              <carousel-navigation aria-controls="{{ carousel_id }}" class="page-dots page-dots--narrow">
                {%- for i in (1..cross_sell_products_count) -%}
                  <button class="relative" aria-current="{% if forloop.first %}true{% else %}false{% endif %}">
                    <span class="sr-only">{{ 'general.accessibility.go_to_item' | t: index: forloop.index }}</span>
                  </button>
                {%- endfor -%}
              </carousel-navigation>
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- liquid
          capture complementary_products
            for product in section.settings.cross_sell_products
              assign products_in_cart = cart.items | where: 'product_id', product.id

              if products_in_cart.size == 0 and product.available
                render 'product-card-horizontal', product: product, show_quick_buy: true
              endif
            endfor
          endcapture
        -%}

        {%- if section.settings.cross_sell_stack_products -%}
          <div class="complementary-products__product-list">
            {{- complementary_products -}}
          </div>
        {%- else -%}
          <scroll-carousel id="{{ carousel_id }}" class="complementary-products__product-list complementary-products__product-list--carousel scroll-area bleed snap-x">
            {{- complementary_products -}}
          </scroll-carousel>
        {%- endif -%}
      </div>
    {%- endif -%}

    <div slot="footer">
      <form action="{{ routes.cart_url }}" class="cart-drawer__footer" method="POST">
        <input type="hidden" name="attributes[products_mobile_grid_mode]" value="">
        <input type="hidden" name="attributes[products_desktop_grid_mode]" value="">

        {%- liquid
          assign upsell_products_count = 0

          if section.settings.upsell_products != blank
            for product in section.settings.upsell_products
              assign in_cart = false
              for item in cart.items
                if item.product_id == product.id
                  assign in_cart = true
                  break
                endif
              endfor

              unless in_cart
                assign upsell_products_count = upsell_products_count | plus: 1
              endunless
            endfor
          endif
        -%}

        {%- if upsell_products_count > 0 -%}
          <div class="cart-upsell-slider">
            <div class="cart-upsell-slider__header">
              <h3 class="cart-upsell-slider__title">{{ section.settings.upsell_title }}</h3>
              <div class="cart-upsell-slider__arrows">
                <button type="button" class="cart-upsell-slider__arrow cart-upsell-slider__arrow--prev" aria-label="Previous">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M10 12L6 8L10 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
                <button type="button" class="cart-upsell-slider__arrow cart-upsell-slider__arrow--next" aria-label="Next">
                  <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                    <path d="M6 12L10 8L6 4" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                  </svg>
                </button>
              </div>
            </div>

            <div class="cart-upsell-slider__container">
              <div class="cart-upsell-slider__track">
                {%- for product in section.settings.upsell_products -%}
                  {%- assign in_cart = false -%}
                  {%- for item in cart.items -%}
                    {%- if item.product_id == product.id -%}
                      {%- assign in_cart = true -%}
                      {%- break -%}
                    {%- endif -%}
                  {%- endfor -%}

                  {%- unless in_cart -%}
                    <div class="cart-upsell-slider__item">
                      <div class="cart-upsell-product">
                        {%- if product.featured_image -%}
                          <div class="cart-upsell-product__image">
                            {{ product.featured_image | image_url: width: 200 | image_tag: loading: 'lazy', alt: product.title }}
                          </div>
                        {%- endif -%}

                        <div class="cart-upsell-product__info">
                          <h4 class="cart-upsell-product__title">{{ product.title }}</h4>
                          <div class="cart-upsell-product__price">
                            {%- if product.compare_at_price > product.price -%}
                              <span class="cart-upsell-product__price--sale">{{ product.price | money }}</span>
                              <span class="cart-upsell-product__price--compare">{{ product.compare_at_price | money }}</span>
                            {%- else -%}
                              <span>{{ product.price | money }}</span>
                            {%- endif -%}
                          </div>
                        </div>

                        <button
                          type="button"
                          class="cart-upsell-product__add-btn"
                          data-product-id="{{ product.selected_or_first_available_variant.id }}"
                          data-product-title="{{ product.title | escape }}"
                        >
                          Add
                        </button>
                      </div>
                    </div>
                  {%- endunless -%}
                {%- endfor -%}
              </div>
            </div>
          </div>
        {%- endif -%}

        {%- if section.settings.show_cart_note or section.settings.show_shipping_text -%}
          <div class="v-stack gap-0.5 justify-items-start">
            {%- if section.settings.show_cart_note -%}
              {%- assign cart_note_dialog_id = 'cart-note-' | append: section.id -%}
              <button class="link-faded-reverse" aria-controls="{{ cart_note_dialog_id }}">{{ 'cart.general.add_order_note' | t }}</button>

              <cart-note-dialog id="{{ cart_note_dialog_id }}" class="cart-drawer__order-note">
                <div class="form">
                  <cart-note class="form-control">
                    {%- assign order_note = 'cart.general.order_note' | t -%}
                    {%- assign placeholder = 'cart.general.note_placeholder' | t -%}
                    {%- render 'input', name: 'note', multiline: 3, label: order_note, value: cart.note, placeholder: placeholder, show_label_as_block: true -%}
                  </cart-note>

                  <dialog-close-button class="contents">
                    <button type="button" class="button">{{ 'cart.general.save_note' | t }}</button>
                  </dialog-close-button>
                </div>
              </cart-note-dialog>
            {%- endif -%}

            {%- if section.settings.show_shipping_text -%}
              <p class="text-subdued">{{ 'cart.general.taxes_and_shipping_at_checkout' | t }}</p>
            {%- endif -%}
          </div>
        {%- endif -%}

        {%- if section.settings.allow_discount_application -%}
          {%- render 'cart-discount' -%}
        {%- endif -%}

        {%- if cart.cart_level_discount_applications.size > 0 -%}
          <div class="h-stack gap-3">
            {%- for discount_application in cart.cart_level_discount_applications -%}
              <div class="h-stack justify-start gap-4">
                <span class="discount-badge text-xs">
                  {%- render 'icon' with 'discount', width: 12 -%}
                  {{ discount_application.title }} (-{{ discount_application.total_allocated_amount | money }})

                  {%- if section.settings.allow_discount_application and discount_application.type != '' -%}
                    <cart-discount-remove-button discount-code="{{ discount_application.title | escape }}" class="h-stack align-center">
                      <button type="button">{%- render 'icon' with 'close', width: 8 -%}</button>
                    </cart-discount-remove-button>
                  {%- endif -%}
                </span>
              </div>
            {%- endfor -%}
          </div>
        {%- endif -%}

        <div class="button-group">
          {%- if section.settings.show_view_cart_button or section.settings.show_checkout_button == false -%}
            {%- assign view_cart = 'cart.general.view_cart' | t -%}
            {%- render 'button', href: routes.cart_url, content: view_cart, stretch: true -%}
          {%- endif -%}

          {%- if section.settings.show_checkout_button -%}
            {%- capture checkout_button -%}
              {{- 'cart.general.checkout' | t -}}

              {%- if section.settings.show_price_in_checkout_button -%}
                <span class="cart-drawer__button-price">{{- cart.total_price | money -}}</span>
              {%- endif -%}
            {%- endcapture -%}

            {%- render 'button', type: 'submit', content: checkout_button, name: 'checkout', stretch: true -%}
          {%- endif -%}
        </div>
      </form>
    </div>
  {%- endif -%}
</cart-drawer>

<style>
  .cart-drawer__footer {
    padding-left: 0 !important;
    padding-right: 0 !important;
  }

  .cart-upsell-slider {
    margin-bottom: 20px;
    padding-bottom: 20px;
    border-bottom: 1px solid #e5e5e5;
    width: 100%;
    margin-left: auto;
    margin-right: auto;
    overflow: hidden;
  }

  .cart-upsell-slider__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 16px;
  }

  .cart-upsell-slider__title {
    font-size: 18px;
    font-weight: 600;
    margin: 0;
    color: #1a1a1a;
  }

  .cart-upsell-slider__arrows {
    display: flex;
    gap: 8px;
  }

  .cart-upsell-slider__arrow {
    width: 32px;
    height: 32px;
    border: 1px solid #d1d5db;
    background: white;
    border-radius: 4px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    transition: all 0.2s ease;
    color: #374151;
    flex-shrink: 0;
  }

  .cart-upsell-slider__arrow svg {
    display: block;
  }

  .cart-upsell-slider__arrow:hover {
    background: #f3f4f6;
    border-color: #9ca3af;
  }

  .cart-upsell-slider__arrow:disabled {
    opacity: 0.3;
    cursor: not-allowed;
  }

  .cart-upsell-slider__container {
    overflow: hidden;
    position: relative;
  }

  .cart-upsell-slider__track {
    display: flex;
    gap: 12px;
    transition: transform 0.3s ease;
  }

  .cart-upsell-slider__item {
    flex: 0 0 auto;
    width: 90%;
  }

  .cart-upsell-product {
    border: 1px solid #e5e5e5;
    border-radius: 8px;
    padding: 12px;
    background: white;
    display: flex;
    gap: 12px;
    align-items: center;
    height: 100%;
  }

  .cart-upsell-product__image {
    flex-shrink: 0;
    width: 70px;
    height: 70px;
    border-radius: 6px;
    overflow: hidden;
    background: #f9fafb;
  }

  .cart-upsell-product__image img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .cart-upsell-product__info {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-direction: column;
    gap: 4px;
  }

  .cart-upsell-product__title {
    font-size: 14px;
    font-weight: 500;
    margin: 0;
    color: #1a1a1a;
    line-height: 1.3;
    overflow: hidden;
    text-overflow: ellipsis;
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
  }

  .cart-upsell-product__price {
    display: flex;
    align-items: center;
    gap: 6px;
    font-size: 14px;
  }

  .cart-upsell-product__price--sale {
    color: #dc2626;
    font-weight: 600;
  }

  .cart-upsell-product__price--compare {
    color: #6b7280;
    text-decoration: line-through;
    font-size: 12px;
  }

  .cart-upsell-product__add-btn {
    flex-shrink: 0;
    background: black;
    color: white;
    border: none;
    border-radius: 20px;
    padding: 8px 18px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s ease;
    white-space: nowrap;
    align-self: center;
  }

  .cart-upsell-product__add-btn:hover {
    background: #1a252f;
  }

  .cart-upsell-product__add-btn:disabled {
    background: #6b7280;
    cursor: not-allowed;
  }

  .cart-upsell-product__add-btn.added {
    background: #059669;
  }
  #cart-drawer{
    z-index: 999999;
  }

  @media (max-width: 768px) {
    .cart-upsell-slider {
      max-width: 100%;
      padding-left: 0;
      padding-right: 12px;
      margin-bottom: 0 !important;
      padding-bottom: 6px !important;
    }
    .cart-upsell-slider__header {
      margin-bottom: 6px !important;
  }

    .cart-upsell-slider__arrows {
      display: none;
    }

    .cart-upsell-slider__container {
      overflow-x: auto;
      overflow-y: hidden;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
      -ms-overflow-style: none;
      cursor: grab;
    }

    .cart-upsell-slider__container::-webkit-scrollbar {
      display: none;
    }

    .cart-upsell-slider__container:active {
      cursor: grabbing;
    }

    .cart-upsell-slider__track {
      transition: none;
      scroll-snap-type: x mandatory;
    }

    .cart-upsell-slider__item {
      width: 85%;
      scroll-snap-align: start;
    }

    .cart-upsell-product {
      gap: 8px;
      padding: 10px;
    }

    .cart-upsell-product__image {
      width: 55px;
      height: 55px;
    }

    .cart-upsell-product__title {
      font-size: 12px;
      line-height: 1.2;
      -webkit-line-clamp: 2;
    }

    .cart-upsell-product__price {
      font-size: 12px;
    }

    .cart-upsell-product__price--compare {
      font-size: 11px;
    }

    .cart-upsell-product__add-btn {
      padding: 6px 14px;
      font-size: 11px;
    }
  }
</style>

<script>
  (function() {
    const upsellSlider = document.querySelector('.cart-upsell-slider');
    if (!upsellSlider) return;

    const track = upsellSlider.querySelector('.cart-upsell-slider__track');
    const prevBtn = upsellSlider.querySelector('.cart-upsell-slider__arrow--prev');
    const nextBtn = upsellSlider.querySelector('.cart-upsell-slider__arrow--next');
    const container = upsellSlider.querySelector('.cart-upsell-slider__container');

    let currentIndex = 0;
    const isMobile = () => window.innerWidth <= 768;

    function getItemWidth() {
      const firstItem = track.querySelector('.cart-upsell-slider__item');
      if (!firstItem) return 292;
      return firstItem.offsetWidth + 12; // item width + gap
    }

    function getVisibleItems() {
      const containerWidth = container.offsetWidth;
      const itemWidth = getItemWidth();
      return Math.floor(containerWidth / itemWidth);
    }

    function getTotalItems() {
      return track.querySelectorAll('.cart-upsell-slider__item').length;
    }

    function updateSliderPosition() {
      if (isMobile()) {
        track.style.transform = '';
        return;
      }

      const itemWidth = getItemWidth();
      const translateX = -(currentIndex * itemWidth);
      track.style.transform = `translateX(${translateX}px)`;
      updateArrowStates();
    }

    function updateArrowStates() {
      if (isMobile()) return;

      const visibleItems = getVisibleItems();
      const totalItems = getTotalItems();
      const maxIndex = Math.max(0, totalItems - visibleItems);

      prevBtn.disabled = currentIndex === 0;
      nextBtn.disabled = currentIndex >= maxIndex;
    }

    if (prevBtn) {
      prevBtn.addEventListener('click', () => {
        if (isMobile()) return;
        if (currentIndex > 0) {
          currentIndex--;
          updateSliderPosition();
        }
      });
    }

    if (nextBtn) {
      nextBtn.addEventListener('click', () => {
        if (isMobile()) return;
        const visibleItems = getVisibleItems();
        const totalItems = getTotalItems();
        const maxIndex = Math.max(0, totalItems - visibleItems);

        if (currentIndex < maxIndex) {
          currentIndex++;
          updateSliderPosition();
        }
      });
    }

    // Handle window resize
    let resizeTimer;
    window.addEventListener('resize', () => {
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(() => {
        if (isMobile()) {
          track.style.transform = '';
          currentIndex = 0;
          return;
        }

        const visibleItems = getVisibleItems();
        const totalItems = getTotalItems();
        const maxIndex = Math.max(0, totalItems - visibleItems);

        if (currentIndex > maxIndex) {
          currentIndex = maxIndex;
          updateSliderPosition();
        } else {
          updateArrowStates();
        }
      }, 250);
    });

    // Add to cart functionality
    const addButtons = upsellSlider.querySelectorAll('.cart-upsell-product__add-btn');

    addButtons.forEach(button => {
      button.addEventListener('click', async function() {
        const productId = this.dataset.productId;
        const productTitle = this.dataset.productTitle;
        const originalText = this.textContent;

        // Disable button during request
        this.disabled = true;

        try {
          // Collect sections that need to be bundled
          const sectionsToBundle = [];
          document.documentElement.dispatchEvent(new CustomEvent('cart:prepare-bundled-sections', {
            bubbles: true,
            detail: { sections: sectionsToBundle }
          }));

          // Prepare form data
          const formData = new FormData();
          formData.append('items[0][id]', productId);
          formData.append('items[0][quantity]', '1');
          formData.append('sections', sectionsToBundle.join(','));

          // Add to cart
          const addResponse = await fetch(`${window.Shopify.routes.root}cart/add.js`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });

          if (!addResponse.ok) {
            throw new Error('Failed to add to cart');
          }

          const addData = await addResponse.json();

          // Fetch updated cart
          const cartResponse = await fetch(`${window.Shopify.routes.root}cart.js`);
          const cart = await cartResponse.json();

          // Add sections from response to cart object
          if (addData.sections) {
            cart.sections = addData.sections;
          }

          // Trigger cart:change event
          document.documentElement.dispatchEvent(new CustomEvent('cart:change', {
            bubbles: true,
            detail: {
              baseEvent: 'variant:add',
              cart: cart
            }
          }));

          // Change button to "Added" with green background
          this.textContent = 'Added';
          this.classList.add('added');

          // Remove the product card from slider after 2 seconds
          setTimeout(() => {
            const item = this.closest('.cart-upsell-slider__item');
            item.style.transition = 'opacity 0.3s ease';
            item.style.opacity = '0';

            setTimeout(() => {
              item.remove();

              // Update slider after removal
              const totalItems = getTotalItems();
              if (totalItems === 0) {
                upsellSlider.style.display = 'none';
              } else {
                const visibleItems = getVisibleItems();
                const maxIndex = Math.max(0, totalItems - visibleItems);
                if (currentIndex > maxIndex) {
                  currentIndex = maxIndex;
                }
                updateSliderPosition();
              }
            }, 300);
          }, 2000);

        } catch (error) {
          console.error('Error adding to cart:', error);

          // Reset button on error
          this.textContent = originalText;
          this.disabled = false;

          alert('Error adding product to cart. Please try again.');
        }
      });
    });

    // Initialize
    if (!isMobile()) {
      updateArrowStates();
    }
  })();
</script>

{% schema %}
{
  "name": "t:sections.cart_drawer.name",
  "class": "shopify-section--cart-drawer",
  "tag": "section",
  "settings": [
    {
      "type": "paragraph",
      "content": "t:sections.cart_drawer.page_info"
    },
    {
      "type": "paragraph",
      "content": "t:sections.cart_drawer.free_shipping_bar_info"
    },
    {
      "type": "color_scheme",
      "id": "color_scheme",
      "label": "t:global.colors.scheme",
      "default": "scheme-1"
    },
    {
      "type": "checkbox",
      "id": "show_cart_note",
      "label": "t:sections.cart_drawer.show_cart_note",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "allow_discount_application",
      "label": "t:sections.cart_drawer.allow_discount_application",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_shipping_text",
      "label": "t:sections.cart_drawer.show_shipping_text",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_view_cart_button",
      "label": "t:sections.cart_drawer.show_view_cart_button",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "show_checkout_button",
      "label": "t:sections.cart_drawer.show_checkout_button",
      "default": true
    },
    {
      "type": "checkbox",
      "id": "show_price_in_checkout_button",
      "label": "t:sections.cart_drawer.show_price_in_checkout_button",
      "default": true
    },
    {
      "type": "header",
      "content": "t:sections.cart_drawer.cross_sell_category"
    },
    {
      "type": "product_list",
      "id": "cross_sell_products",
      "label": "t:sections.cart_drawer.cross_sell_products",
      "info": "t:sections.cart_drawer.cross_sell_products_info",
      "limit": 5
    },
    {
      "type": "inline_richtext",
      "id": "cross_sell_title",
      "label": "t:sections.cart_drawer.cross_sell_heading",
      "default": "Complete with",
      "visible_if": "{{ section.settings.cross_sell_products != blank }}"
    },
    {
      "type": "checkbox",
      "id": "cross_sell_stack_products",
      "label": "t:sections.cart_drawer.cross_sell_stack_products",
      "default": false,
      "visible_if": "{{ section.settings.cross_sell_products != blank }}"
    },
    {
      "type": "header",
      "content": "Upsell Products (Footer)"
    },
    {
      "type": "product_list",
      "id": "upsell_products",
      "label": "Upsell Products",
      "info": "Products shown in 'You may also like' slider in cart footer",
      "limit": 10
    },
    {
      "type": "inline_richtext",
      "id": "upsell_title",
      "label": "Upsell Heading",
      "default": "You may also like"
    }
  ]
}
{% endschema %}