{%- comment -%}
----------------------------------------------------------------------------------------------------------------------
PRODUCT BUNDLE
----------------------------------------------------------------------------------------------------------------------

This snippet renders a product bundle block with checkboxes and dynamic pricing

********************************************
Supported variables
********************************************

* block: the block settings
* product: the current product
{%- endcomment -%}

{%- liquid
  assign bundle_product_1 = block.settings.bundle_product_1
  assign bundle_product_2 = block.settings.bundle_product_2
  assign bundle_product_3 = block.settings.bundle_product_3
  assign bundle_product_4 = block.settings.bundle_product_4
  assign discount_percentage = block.settings.discount_percentage
  assign discount_code = block.settings.discount_code
-%}

{%- if bundle_product_1 != blank or bundle_product_2 != blank or bundle_product_3 != blank or bundle_product_4 != blank -%}
  <style>
    .product-bundle {
      border: 1px solid #cfcfcf;
      padding: 20px;
      margin: 20px 0;
    }

    .product-bundle__title {
      font-size: 18px;
      font-weight: 700;
      text-align: left;
      margin-bottom: 15px;
      letter-spacing: 1px;
    }

    .product-bundle__images {
      display: flex;
      justify-content: flex-start;
      gap: 15px;
      margin-bottom: 20px;
      min-height: 120px;
      align-items: center;
    }

    .product-bundle__image-wrapper {
      width: 100px;
      height: 100px;
      border: 1px solid #e5e5e5;
      overflow: hidden;
      display: none;
      background: #f9f9f9;
    }

    .product-bundle__image-wrapper.active {
      display: block;
    }

    .product-bundle__image-wrapper img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .product-bundle__prices {
      text-align: center;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .product-bundle__prices span {
      margin: 0 5px;
    }

    .product-bundle__old-price {
      text-decoration: line-through;
      color: #666;
    }

    .product-bundle__new-price {
      font-weight: 700;
      color: {{ block.settings.new_price_color }};
    }

    .product-bundle__promo-wrapper {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 8px;
      font-size: 14px;
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .product-bundle__promo-code {
      padding: 4px 10px;
      color: white;
      background: red;
      cursor: pointer;
      font-weight: 600;
    }

    .product-bundle__promo-code:hover {
      opacity: 0.9;
    }

    .product-bundle__copy-message {
      display: none;
      color: green;
      font-size: 13px;
      font-weight: 600;
    }

    .product-bundle__copy-message.show {
      display: inline-block;
    }

    .product-bundle__items {
      margin-bottom: 15px;
    }

    .product-bundle__item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 0;
      border-bottom: 1px solid #f0f0f0;
    }

    .product-bundle__item:last-child {
      border-bottom: none;
    }

    .product-bundle__item-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .product-bundle__checkbox {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }

    .product-bundle__item-label {
      font-weight: 600;
      font-size: 14px;
      max-width: 150px;
      line-height: 16px;
    }

    .product-bundle__item-prices {
      text-align: right;
      font-size: 14px;
    }

    .product-bundle__item-old-price {
      display: block;
      text-decoration: line-through;
      color: #999;
      font-size: 12px;
    }

    .product-bundle__item-new-price {
      color: {{ block.settings.new_price_color }};
      font-weight: 700;
    }

    .product-bundle__button {
      width: 100%;
      padding: 15px;
      background: #000;
      color: white;
      border: none;
      font-size: 16px;
      font-weight: 700;
      cursor: pointer;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .product-bundle__button:hover {
      background: #1a252f;
    }

    .product-bundle__button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    @media screen and (max-width: 767px){
    .product-bundle__prices {
        font-size: 16px;
    }
    }
  </style>

  <div class="product-bundle" {{ block.shopify_attributes }}>
    <div class="product-bundle__title">{{ block.settings.bundle_title }}</div>

    {%- comment -%} Image Preview Area {%- endcomment -%}
    <div class="product-bundle__images" id="bundle-images-{{ block.id }}">
      {%- if bundle_product_1 != blank -%}
        <div class="product-bundle__image-wrapper" id="bundle-image-1-{{ block.id }}" data-product-id="{{ bundle_product_1.id }}">
          {%- if bundle_product_1.featured_image -%}
            {{ bundle_product_1.featured_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if bundle_product_2 != blank -%}
        <div class="product-bundle__image-wrapper" id="bundle-image-2-{{ block.id }}" data-product-id="{{ bundle_product_2.id }}">
          {%- if bundle_product_2.featured_image -%}
            {{ bundle_product_2.featured_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if bundle_product_3 != blank -%}
        <div class="product-bundle__image-wrapper" id="bundle-image-3-{{ block.id }}" data-product-id="{{ bundle_product_3.id }}">
          {%- if bundle_product_3.featured_image -%}
            {{ bundle_product_3.featured_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
          {%- endif -%}
        </div>
      {%- endif -%}

      {%- if bundle_product_4 != blank -%}
        <div class="product-bundle__image-wrapper" id="bundle-image-4-{{ block.id }}" data-product-id="{{ bundle_product_4.id }}">
          {%- if bundle_product_4.featured_image -%}
            {{ bundle_product_4.featured_image | image_url: width: 200 | image_tag: loading: 'lazy' }}
          {%- endif -%}
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Price Display {%- endcomment -%}
    <div class="product-bundle__prices">
      <span>WAS:
        <span class="product-bundle__old-price" id="bundle-old-price-{{ block.id }}">$0.00</span>
      </span>
      <span>TODAY:
        <span class="product-bundle__new-price" id="bundle-new-price-{{ block.id }}">$0.00</span>
      </span>
    </div>

    {%- comment -%} Promo Code Banner {%- endcomment -%}
    {%- if discount_code != blank -%}
      <div class="product-bundle__promo-wrapper">
        <span>ENTER CODE</span>
        <div class="product-bundle__promo-code" id="bundle-promo-code-{{ block.id }}">{{ discount_code }}</div>
        <span>AT CHECKOUT</span>
      </div>
      <div style="text-align: center;">
        <span class="product-bundle__copy-message" id="bundle-copy-msg-{{ block.id }}">Copied!</span>
      </div>
    {%- endif -%}

    {%- comment -%} Product Checkboxes {%- endcomment -%}
    <div class="product-bundle__items">
      {%- if bundle_product_1 != blank -%}
        {%- liquid
          assign product_1_price = bundle_product_1.price | money_without_currency | plus: 0
          assign product_1_discount = product_1_price | times: discount_percentage | divided_by: 100.0
          assign product_1_new_price = product_1_price | minus: product_1_discount
        -%}
        <div class="product-bundle__item">
          <div class="product-bundle__item-left">
            <input
              type="checkbox"
              class="product-bundle__checkbox bundle-checkbox"
              id="bundle-product-1-{{ block.id }}"
              data-product-id="{{ bundle_product_1.selected_or_first_available_variant.id }}"
              data-price="{{ product_1_price }}"
              data-discount="{{ discount_percentage }}"
              data-image-id="bundle-image-1-{{ block.id }}"
              data-bundle-id="{{ block.id }}"
              checked
            >
            <label for="bundle-product-1-{{ block.id }}" class="product-bundle__item-label">
              {%- if block.settings.product_1_label != blank and block.settings.product_1_label != 'Product 1' -%}
                {{ block.settings.product_1_label }}
              {%- else -%}
                {{ bundle_product_1.title }}
              {%- endif -%}
            </label>
          </div>
          <div class="product-bundle__item-prices">
            <span class="product-bundle__item-old-price">${{ product_1_price | round: 2 }}</span>
            <span class="product-bundle__item-new-price">
              ${{ product_1_new_price | round: 2 }}
              <span style="font-size: 11px; color: #e74c3c;">with code {{ discount_code }}</span>
            </span>
          </div>
        </div>
      {%- endif -%}

      {%- if bundle_product_2 != blank -%}
        {%- liquid
          assign product_2_price = bundle_product_2.price | money_without_currency | plus: 0
          assign product_2_discount = product_2_price | times: discount_percentage | divided_by: 100.0
          assign product_2_new_price = product_2_price | minus: product_2_discount
        -%}
        <div class="product-bundle__item">
          <div class="product-bundle__item-left">
            <input
              type="checkbox"
              class="product-bundle__checkbox bundle-checkbox"
              id="bundle-product-2-{{ block.id }}"
              data-product-id="{{ bundle_product_2.selected_or_first_available_variant.id }}"
              data-price="{{ product_2_price }}"
              data-discount="{{ discount_percentage }}"
              data-image-id="bundle-image-2-{{ block.id }}"
              data-bundle-id="{{ block.id }}"
              checked
            >
            <label for="bundle-product-2-{{ block.id }}" class="product-bundle__item-label">
              {%- if block.settings.product_2_label != blank and block.settings.product_2_label != 'Product 2' -%}
                {{ block.settings.product_2_label }}
              {%- else -%}
                {{ bundle_product_2.title }}
              {%- endif -%}
            </label>
          </div>
          <div class="product-bundle__item-prices">
            <span class="product-bundle__item-old-price">${{ product_2_price | round: 2 }}</span>
            <span class="product-bundle__item-new-price">
              ${{ product_2_new_price | round: 2 }}
              <span style="font-size: 11px; color: #e74c3c;">with code {{ discount_code }}</span>
            </span>
          </div>
        </div>
      {%- endif -%}

      {%- if bundle_product_3 != blank -%}
        {%- liquid
          assign product_3_price = bundle_product_3.price | money_without_currency | plus: 0
          assign product_3_discount = product_3_price | times: discount_percentage | divided_by: 100.0
          assign product_3_new_price = product_3_price | minus: product_3_discount
        -%}
        <div class="product-bundle__item">
          <div class="product-bundle__item-left">
            <input
              type="checkbox"
              class="product-bundle__checkbox bundle-checkbox"
              id="bundle-product-3-{{ block.id }}"
              data-product-id="{{ bundle_product_3.selected_or_first_available_variant.id }}"
              data-price="{{ product_3_price }}"
              data-discount="{{ discount_percentage }}"
              data-image-id="bundle-image-3-{{ block.id }}"
              data-bundle-id="{{ block.id }}"
              checked
            >
            <label for="bundle-product-3-{{ block.id }}" class="product-bundle__item-label">
              {%- if block.settings.product_3_label != blank and block.settings.product_3_label != 'Product 3' -%}
                {{ block.settings.product_3_label }}
              {%- else -%}
                {{ bundle_product_3.title }}
              {%- endif -%}
            </label>
          </div>
          <div class="product-bundle__item-prices">
            <span class="product-bundle__item-old-price">${{ product_3_price | round: 2 }}</span>
            <span class="product-bundle__item-new-price">
              ${{ product_3_new_price | round: 2 }}
              <span style="font-size: 11px; color: #e74c3c;">with code {{ discount_code }}</span>
            </span>
          </div>
        </div>
      {%- endif -%}

      {%- if bundle_product_4 != blank -%}
        {%- liquid
          assign product_4_price = bundle_product_4.price | money_without_currency | plus: 0
          assign product_4_discount = product_4_price | times: discount_percentage | divided_by: 100.0
          assign product_4_new_price = product_4_price | minus: product_4_discount
        -%}
        <div class="product-bundle__item">
          <div class="product-bundle__item-left">
            <input
              type="checkbox"
              class="product-bundle__checkbox bundle-checkbox"
              id="bundle-product-4-{{ block.id }}"
              data-product-id="{{ bundle_product_4.selected_or_first_available_variant.id }}"
              data-price="{{ product_4_price }}"
              data-discount="{{ discount_percentage }}"
              data-image-id="bundle-image-4-{{ block.id }}"
              data-bundle-id="{{ block.id }}"
              checked
            >
            <label for="bundle-product-4-{{ block.id }}" class="product-bundle__item-label">
              {%- if block.settings.product_4_label != blank and block.settings.product_4_label != 'Product 4' -%}
                {{ block.settings.product_4_label }}
              {%- else -%}
                {{ bundle_product_4.title }}
              {%- endif -%}
            </label>
          </div>
          <div class="product-bundle__item-prices">
            <span class="product-bundle__item-old-price">${{ product_4_price | round: 2 }}</span>
            <span class="product-bundle__item-new-price">
              ${{ product_4_new_price | round: 2 }}
              <span style="font-size: 11px; color: #e74c3c;">with code {{ discount_code }}</span>
            </span>
          </div>
        </div>
      {%- endif -%}
    </div>

    {%- comment -%} Add Bundle Button {%- endcomment -%}
    <button
      type="button"
      class="product-bundle__button"
      id="bundle-add-btn-{{ block.id }}"
      data-bundle-id="{{ block.id }}"
    >
      ADD BUNDLE TO CART
    </button>
  </div>

  <script>
    (function() {
      const bundleId = '{{ block.id }}';
      const discountPercentage = {{ discount_percentage }};

      // Update prices based on checkbox state
      function updateBundlePrices() {
        const checkboxes = document.querySelectorAll(`[data-bundle-id="${bundleId}"].bundle-checkbox:checked`);
        let totalOldPrice = 0;
        let totalNewPrice = 0;

        checkboxes.forEach(checkbox => {
          const price = parseFloat(checkbox.dataset.price);
          const discount = parseFloat(checkbox.dataset.discount);
          totalOldPrice += price;
          totalNewPrice += price - (price * discount / 100);
        });

        document.getElementById(`bundle-old-price-${bundleId}`).textContent = `$${totalOldPrice.toFixed(2)}`;
        document.getElementById(`bundle-new-price-${bundleId}`).textContent = `$${totalNewPrice.toFixed(2)}`;

        // Enable/disable button
        const button = document.getElementById(`bundle-add-btn-${bundleId}`);
        button.disabled = checkboxes.length === 0;
      }

      // Toggle image visibility
      function toggleImage(imageId, show) {
        const imageWrapper = document.getElementById(imageId);
        if (imageWrapper) {
          if (show) {
            imageWrapper.classList.add('active');
          } else {
            imageWrapper.classList.remove('active');
          }
        }
      }

      // Checkbox change handler
      document.querySelectorAll(`[data-bundle-id="${bundleId}"].bundle-checkbox`).forEach(checkbox => {
        checkbox.addEventListener('change', function() {
          toggleImage(this.dataset.imageId, this.checked);
          updateBundlePrices();
        });

        // Initialize image visibility
        if (checkbox.checked) {
          toggleImage(checkbox.dataset.imageId, true);
        }
      });

      // Copy promo code
      const promoCode = document.getElementById(`bundle-promo-code-${bundleId}`);
      if (promoCode) {
        promoCode.addEventListener('click', function() {
          const code = this.textContent;
          navigator.clipboard.writeText(code).then(() => {
            const copyMsg = document.getElementById(`bundle-copy-msg-${bundleId}`);
            copyMsg.classList.add('show');
            setTimeout(() => {
              copyMsg.classList.remove('show');
            }, 2000);
          });
        });
      }

      // Add to cart functionality
      document.getElementById(`bundle-add-btn-${bundleId}`).addEventListener('click', async function() {
        const checkboxes = document.querySelectorAll(`[data-bundle-id="${bundleId}"].bundle-checkbox:checked`);
        const items = [];

        checkboxes.forEach(checkbox => {
          items.push({
            id: checkbox.dataset.productId,
            quantity: 1
          });
        });

        if (items.length === 0) {
          alert('Please select at least one product');
          return;
        }

        // Disable button during add to cart
        this.disabled = true;
        this.textContent = 'ADDING...';

        try {
          // Collect sections that need to be bundled
          const sectionsToBundle = [];
          document.documentElement.dispatchEvent(new CustomEvent('cart:prepare-bundled-sections', {
            bubbles: true,
            detail: { sections: sectionsToBundle }
          }));

          // Prepare form data
          const formData = new FormData();
          items.forEach((item, index) => {
            formData.append(`items[${index}][id]`, item.id);
            formData.append(`items[${index}][quantity]`, item.quantity);
          });
          formData.append('sections', sectionsToBundle.join(','));

          // Add items to cart
          const addResponse = await fetch(`${Shopify.routes.root}cart/add.js`, {
            method: 'POST',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
          });

          if (!addResponse.ok) {
            throw new Error('Failed to add to cart');
          }

          const addData = await addResponse.json();

          // Fetch updated cart
          const cartResponse = await fetch(`${Shopify.routes.root}cart.js`);
          const cart = await cartResponse.json();

          // Add sections from response to cart object
          if (addData.sections) {
            cart.sections = addData.sections;
          }

          // Trigger cart:change event with proper structure
          document.documentElement.dispatchEvent(new CustomEvent('cart:change', {
            bubbles: true,
            detail: {
              baseEvent: 'variant:add',
              cart: cart,
              onSuccessDo: 'force_open_drawer'
            }
          }));

          // Show success message
          this.textContent = 'ADDED TO CART!';
          setTimeout(() => {
            this.textContent = 'ADD BUNDLE TO CART';
            this.disabled = false;
          }, 2000);

        } catch (error) {
          console.error('Error adding to cart:', error);
          alert('Error adding products to cart. Please try again.');
          this.textContent = 'ADD BUNDLE TO CART';
          this.disabled = false;
        }
      });

      // Initialize prices
      updateBundlePrices();
    })();
  </script>
{%- endif -%}
